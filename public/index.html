<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps Production Co Player</title>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%23e53935'/%3E%3C/svg%3E" />

  <style>
    :root{
      --btn-bg:#e53935;--btn-bg-h:#d32f2f;--btn-bg-a:#b71c1c;--btn-txt:#fff;
      --panel-bg:#0b0b0fcc;--panel-bd:#ffffff26;
      /* Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙÙŠ ÙˆØ¶Ø¹ Overscan Ù„Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ù„ÙŠØªØ±-Ø¨ÙˆÙƒØ³ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
      --overscan:1.08;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}

    /* Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø© */
    #mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}
    #mainPreview video{display:block;width:100%;height:100%;object-fit:contain}

    /* ØªÙ‚Ø³ÙŠÙ… */
    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}

    /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù„Ø¡ ÙÙŠ Ø§Ù„ØªÙ‚Ø³ÙŠÙ… */
    .split.fit-0 #mainPreview video,
    .split.fit-0 #activeCam  video{object-fit:contain}

    .split.fit-1 #mainPreview video,
    .split.fit-1 #activeCam  video{object-fit:cover;transform:scale(.985);transform-origin:center}

    .split.fit-2 #mainPreview video,
    .split.fit-2 #activeCam  video{object-fit:cover}

    /* ÙÙÙ„-Ø¨Ù„ÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø­ÙˆØ§Ù Ø³ÙˆØ¯Ø§Ø¡ Ø¹Ø¨Ø± Overscan */
    .split.fit-3 #mainPreview video,
    .split.fit-3 #activeCam  video{object-fit:cover;transform:scale(var(--overscan));transform-origin:center}

    /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ) */
    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    /* Ø¨Ø¯ÙˆÙ† Ø­ÙˆØ§Ù Ø³ÙˆØ¯Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ¨ÙŠØ± */
    .main-full.no-bars #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    #utilityControls,#camControls,#globalControls{position:absolute;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);align-items:center;min-width:340px}
    #globalControls.hidden{display:none}

    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(211,47,47,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(211,47,47,.28)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}

    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}

    #camControls{bottom:14px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd)}

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #scrub{width:clamp(140px,56vw,380px)}
      #camControls{top:60px;left:6px;right:auto;bottom:auto;flex-direction:column;gap:6px;padding:8px 6px;max-height:58vh;overflow:auto;background:linear-gradient(180deg,#0b0b0fb3,#0b0b0f99);border:1px solid var(--panel-bd);border-radius:14px;width:46px;transition:width .18s,box-shadow .18s;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:12}
      #camControls:hover,#camControls.expanded{width:150px}
      #camControls button{justify-content:flex-start;padding:8px 10px;width:100%;font-size:10px;background:#1a1f2a;color:#fff;border:1px solid #ffffff1f;box-shadow:inset 0 0 0 1px #0003}
      #camControls:not(.expanded):not(:hover) button span{display:none}
    }
  </style>
</head>
<body>
  <div id="playerContainer" aria-label="Ù…Ø´ØºÙ‘Ù„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
    <div id="activeCam" class="videoFrame" aria-label="Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù†Ø´Ø·Ø©"></div>
    <div id="mainPreview" class="videoFrame" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±" aria-label="Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø©"></div>
    <div class="hint">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ± â€¢ Ø£Ùˆ Ø§Ø¶ØºØ· F</div>

    <!-- Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¨Ø¯Ø¡ -->
    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„">
      <div class="gate-card">
        <div class="icon">â–¶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
          <div style="font-size:12px;color:#eaeaf0b3">Ø³ÙŠØ¸Ù‡Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…/Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ´ØºÙŠÙ„</div>
        </div>
        <button id="startBtn" aria-label="Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†">ØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
      </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª -->
    <div id="utilityControls" role="toolbar" aria-label="Ø£Ø¯ÙˆØ§Øª">
      <button id="btnSplit" aria-label="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…" title="ØªÙ‚Ø³ÙŠÙ…">ØªÙ‚Ø³ÙŠÙ…</button>
      <button id="btnFill"  aria-label="ØªØ¨Ø¯ÙŠÙ„ Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰" title="Ù…Ù„Ø¡">Ù…Ù„Ø¡</button>
      <button id="btnSound" aria-label="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª" title="ØµÙˆØª">ğŸ”Š/ğŸ”‡</button>
    </div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯ -->
    <div id="globalControls" class="hidden" role="group" aria-label="ØªØ­ÙƒÙ… Ù…ÙˆØ­Ù‘Ø¯">
      <button id="gBack" title="âª -5s">âª 5s</button>
      <button id="gPlay" title="â¯">â¯</button>
      <button id="gFwd"  title="+5s â©">5s â©</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª -->
    <div id="camControls" role="toolbar" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
      <button data-cam="cam1"><span>Cam1</span></button>
      <button data-cam="cam2"><span>Cam2</span></button>
      <button data-cam="cam3"><span>Cam3</span></button>
      <button data-cam="cam4"><span>Cam4</span></button>
      <button data-cam="cam5"><span>Cam5</span></button>
      <button data-cam="cam6"><span>Drone</span></button>
      <button data-cam="cam7"><span>Sineflex</span></button>
    </div>
  </div>

  <!-- ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„ÙˆØ±ÙƒØ± Ù„Ø¯ÙŠÙƒ -->
  <script>
    window.HLS_BASE = "https://hls-proxy.it-f2c.workers.dev";
  </script>

  <script>
    (function(){
      const BASE = (window.HLS_BASE || "").replace(/\/$/, "");
      function build(p){ return BASE ? `${BASE}${p}` : p; }
      window.sources = {
        main: build("/hls/live/playlist.m3u8"),
        cam1: build("/hls/lastone/playlist.m3u8"),
        cam2: build("/hls/live2/playlist.m3u8"),
        cam3: build("/hls/live3/playlist.m3u8"),
        cam4: build("/hls/live4/playlist.m3u8"),
        cam5: build("/hls/live5/playlist.m3u8"),
        cam6: build("/hls/live6/playlist.m3u8"),
        cam7: build("/hls/live7/playlist.m3u8")
      };
    })();
  </script>

  <script>
    /* ====== Ø¹Ø§Ù… ====== */
    const hasUrl = (u)=> typeof u==='string' && /(https?:\/\/[^/]+)?\/hls\/.+\.m3u8(\?.*)?$/i.test(u);
    const SAFETY_EDGE = 0.25;

    const isAvc = l => /avc1/i.test(l?.codecs || l?.codecsVideo || "");
    const isHevc = l => /(hvc1|hev1)/i.test(l?.codecs || l?.codecsVideo || "");
    const pickBestAvc = (levels, cap=480)=>{
      if(!levels?.length) return -1;
      const avc = levels.map((l,i)=>({i,h:l.height||0,avc:isAvc(l)})).filter(x=>x.avc);
      if(!avc.length) return 0;
      let c = avc.filter(x=>x.h && x.h<=cap); if(!c.length) c = avc;
      c.sort((a,b)=>a.h-b.h); return c[c.length-1].i;
    };
    const highestAvcIndex = (levels)=>{
      let max=-1; (levels||[]).forEach((l,i)=>{ if(isAvc(l)) max=i; });
      return max>=0 ? max : (levels?.length? levels.length-1 : -1);
    };

    const HLS_CFG = {
      lowLatencyMode:false,
      liveSyncDurationCount:3,
      liveMaxLatencyDurationCount:6,
      maxLiveSyncPlaybackRate:1.06,

      capLevelToPlayerSize:true,
      enableWorker:true,

      maxBufferLength:10,
      backBufferLength:10,
      maxBufferHole:0.8,
      maxSeekHole:1.5,
      nudgeOffset:0.18,
      nudgeMaxRetry:8,
      abrMaxWithRealBitrate:true,

      fragLoadingMaxRetry:6, manifestLoadingMaxRetry:6, levelLoadingMaxRetry:5,
      fragLoadingRetryDelay:350, manifestLoadingRetryDelay:500, levelLoadingRetryDelay:500,
      fragLoadingTimeOut:10000, manifestLoadingTimeOut:8000, levelLoadingTimeOut:8000,

      xhrSetup:(xhr)=>{ try{ xhr.withCredentials=false; }catch(e){} }
    };

    function getSeekableRange(v){
      try{ const r=v.seekable; if(!r||!r.length) return null;
        return {start:r.start(r.length-1), end:r.end(r.length-1)}; }catch(e){ return null; }
    }
    function clampToSeekable(v,t){
      const m=getSeekableRange(v); if(!m) return t;
      const a=m.start+0.02, b=m.end-0.02; if(b<=a) return m.start;
      return Math.min(Math.max(t,a), b);
    }
    async function waitForSeekable(v, timeout=8000){
      const t0=performance.now();
      return new Promise((res)=>{ (function loop(){
        try{ const r=v.seekable; if(r&&r.length) return res(true); }catch(e){}
        if(performance.now()-t0>timeout) return res(false);
        setTimeout(loop,120);
      })(); });
    }
    async function healGapIfNeeded(v){
      try{
        const r=v.buffered; if(!r||!r.length) return false;
        const t=v.currentTime||0;
        for(let i=0;i<r.length;i++){
          const s=r.start(i), e=r.end(i);
          if(t>=s && t<=e) return false;
          if(t< s){ v.currentTime = s+0.04; await v.play().catch(()=>{}); return true; }
        }
      }catch(e){}
      return false;
    }

    function attachHlsWithAvc(video, url){
      const hls = new Hls({...HLS_CFG});
      video.__hls = hls;
      hls.attachMedia(video);
      hls.on(Hls.Events.MEDIA_ATTACHED,()=>{ hls.loadSource(url); });

      hls.on(Hls.Events.MANIFEST_PARSED,(_,data)=>{
        try{
          const levels=data?.levels||[];
          const startIdx = pickBestAvc(levels, 480);
          const maxAvcIdx = highestAvcIndex(levels);
          if(startIdx >= 0){ hls.startLevel=startIdx; hls.currentLevel=startIdx; hls.nextLevel=startIdx; }
          if(maxAvcIdx >= 0){ hls.autoLevelCapping = maxAvcIdx; }
        }catch(e){}
      });

      hls.on(Hls.Events.LEVEL_SWITCHING,(_,data)=>{
        try{
          const l = hls.levels?.[data.level];
          if(l && isHevc(l)){
            const lv=hls.levels||[];
            const avc = lv.map((x,i)=>({i,h:x.height||0,avc:isAvc(x)})).filter(x=>x.avc);
            if(avc.length){
              let best = avc.reduce((a,b)=> b.h<=480 && b.h>a.h ? b : a, avc[0]);
              hls.nextLevel = best.i;
            }
          }
        }catch(e){}
      });

      hls.on(Hls.Events.ERROR,(_,err)=>{
        if(err?.fatal){
          try{ hls.destroy(); }catch(e){}
          try{ attachHlsWithAvc(video, url); }catch(e){}
        }
      });

      return hls;
    }

    function createVideo(container, url){
      const wrap=document.createElement('div');
      wrap.style.cssText='position:absolute;inset:0;opacity:0;transition:opacity .22s ease';
      container.appendChild(wrap);

      const v=document.createElement('video');
      v.playsInline=true; v.muted=true; v.controls=false; v.preload='auto'; v.crossOrigin='anonymous';
      v.style.cssText='width:100%;height:100%;object-fit:contain';
      wrap.appendChild(v);

      if(hasUrl(url) && window.Hls && Hls.isSupported()){
        attachHlsWithAvc(v, url);
      }else if(hasUrl(url) && v.canPlayType('application/vnd.apple.mpegURL')){
        v.src=url;
      }else{
        v.src=url;
      }

      // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµØ¨Ø­ Ø¬Ø§Ù‡Ø²Ù‹Ø§ Ù†ÙØ¸Ù‡Ø±Ù‡ ÙˆÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
      v.addEventListener('canplay', ()=>{
        wrap.style.opacity='1';
        [...container.children].slice(0,-1).forEach(ch=>{
          try{ const vv=ch.querySelector?.('video'); vv?.pause?.(); vv?.__hls?.destroy?.(); ch.remove(); }catch(e){}
        });
      }, {once:true});

      // ØªØ¹Ø§ÙÙŠ Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù
      const revive=async()=>{
        if(v.paused){ try{ await v.play(); }catch(e){} }
        healGapIfNeeded(v);
      };
      v.addEventListener('waiting',revive);
      v.addEventListener('stalled',revive);

      return v;
    }

    /* ====== DOM ====== */
    const root=document.getElementById('playerContainer');
    const mainContainer=document.getElementById('mainPreview');
    const camContainer =document.getElementById('activeCam');
    const gatePlay     =document.getElementById('gatePlay');
    const startBtn     =document.getElementById('startBtn');
    const btnSplit     =document.getElementById('btnSplit');
    const btnFill      =document.getElementById('btnFill');
    const btnSound     =document.getElementById('btnSound');
    const globalControls=document.getElementById('globalControls');
    const gPlay=document.getElementById('gPlay');
    const gBack=document.getElementById('gBack');
    const gFwd=document.getElementById('gFwd');
    const scrub=document.getElementById('scrub');
    const timeLabel=document.getElementById('timeLabel');

    let started=false, splitMode=0, isMainFull=false;
    let fillState=0; // 0 contain, 1 padded cover, 2 full cover, 3 overscan cover
    let mainPlayer, activePlayer, currentCam='cam2';
    let ticker=null, isScrubbing=false, lastHardSync=0;

    const fmt = (t)=>{ t=Math.max(0,Math.floor(t||0)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; };

    function initPlayers(){
      if(!mainPlayer) mainPlayer=createVideo(mainContainer, sources.main);
      activePlayer=createVideo(camContainer, sources[currentCam]);
    }
    function initOnce(){
      initPlayers();
      document.querySelectorAll('#camControls [data-cam]').forEach(btn=>{
        const id=btn.getAttribute('data-cam');
        if(id!=='cam1' && !hasUrl(sources[id])) btn.style.display='none';
      });
    }
    initOnce();

    async function startPlayback(){
      if(started) return;
      started=true;
      gatePlay.classList.add('hidden');
      globalControls.classList.remove('hidden');

      try{ await mainPlayer.play(); }catch(e){}
      try{ await activePlayer.play(); }catch(e){}

      setTimeout(async ()=>{
        await waitForSeekable(mainPlayer);
        const m=getSeekableRange(mainPlayer);
        if(m){ mainPlayer.currentTime = clampToSeekable(mainPlayer, m.end - SAFETY_EDGE); }
      }, 300);

      startTimeTicker();
    }

    function startTimeTicker(){
      if(ticker) return;
      ticker=setInterval(()=>{
        if(isScrubbing || !mainPlayer) return;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ·
        let d=0, ct=mainPlayer.currentTime||0;
        const r=mainPlayer.seekable; if(r&&r.length) d=r.end(r.length-1);
        if(d&&isFinite(d)) scrub.max=d;
        scrub.value=ct||0; timeLabel.textContent=`${fmt(ct)} / ${fmt(d||0)}`;

        // ØªØ¶Ù…ÙŠØ¯ ÙØ¬ÙˆØ§Øª
        healGapIfNeeded(mainPlayer);
        if(activePlayer) healGapIfNeeded(activePlayer);

        // Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø§Ø¹Ù…Ø© + ØªØµØ­ÙŠØ­ Ø§Ù†Ø¬Ø±Ø§Ù
        if(activePlayer){
          const target = mainPlayer.currentTime||0;
          const delta  = (activePlayer.currentTime||0) - target;
          const ad = Math.abs(delta);

          // Ø¥Ø°Ø§ Ø§Ù„ØªÙØ§ÙˆØª ÙƒØ¨ÙŠØ±Ø› ÙƒÙ„ ~3Ø« Ù†Ø¹Ù…Ù„ Ù‚ÙØ²Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
          const now=performance.now();
          if(ad>1.0 && now-lastHardSync>3000){
            activePlayer.currentTime = clampToSeekable(activePlayer, target);
            lastHardSync=now;
            activePlayer.playbackRate=1;
          }else{
            if(ad < 0.08){ activePlayer.playbackRate=1; }
            else if(ad < 0.30){ activePlayer.playbackRate = (delta>0?0.985:1.015); }
            else { activePlayer.playbackRate = (delta>0?0.95:1.05); }
          }
        }
      }, 260);
    }

    /* ====== ØªØ­ÙƒÙ… ====== */
    startBtn.addEventListener('click', startPlayback);

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¹ ØªÙ…Ù‡ÙŠØ¯ Ù…Ø³Ø¨Ù‚ ÙˆØªÙ„Ø§Ø´ÙŠ
    document.getElementById('camControls').addEventListener('click', async (e)=>{
      const b=e.target.closest('button[data-cam]'); if(!b) return;
      const id=b.getAttribute('data-cam'); if(!hasUrl(sources[id])) return;
      if(id===currentCam) return;
      currentCam=id;

      const newcomerContainer = camContainer;
      const newcomer=createVideo(newcomerContainer, sources[id]);

      const prep = async ()=>{
        await waitForSeekable(newcomer);
        // Ø§Ø¶Ø¨Ø· ÙˆÙ‚Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const t = mainPlayer?.currentTime||0;
        newcomer.currentTime = clampToSeekable(newcomer, t);

        // Ø§Ù†ØªØ¸Ø± Ø¬Ø²Ø¡Ù‹Ø§ ØµØºÙŠØ±Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¨ÙˆÙØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø±
        const ok = await new Promise(res=>{
          let tries=0;
          const check=()=>{
            try{
              const r=newcomer.buffered;
              if(r&&r.length){
                const end=r.end(r.length-1);
                if(end - newcomer.currentTime > 0.35) return res(true);
              }
            }catch(_){}
            if(++tries>25) return res(false);
            setTimeout(check,50);
          };
          check();
        });

        try{ await newcomer.play(); }catch(_){}
        activePlayer=newcomer;
      };

      prep(); // Ù„Ø§ Ù†Ù†ØªØ¸Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø± ÙŠØªÙ… Ø¨Ø¹Ø¯ canplay (Ù…Ø¹ Fade-in) Ø«Ù… Ù†ÙƒÙ…Ù„ Ø§Ù„ØªØ²Ø§Ù…Ù†
    });

    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø©
    btnSplit.addEventListener('click', ()=>{
      splitMode=(splitMode+1)%3;
      root.classList.toggle('split', splitMode!==0);
      if(splitMode!==0){
        fillState=0;
        root.classList.remove('fit-1','fit-2','fit-3');
        root.classList.add('fit-0');
      }else{
        root.classList.remove('fit-0','fit-1','fit-2','fit-3');
      }
    });

    // Ø²Ø± Ù…Ù„Ø¡ â€“ ÙÙŠ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…: 4 Ø­Ø§Ù„Ø§Øª (0..3) / ÙÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    btnFill.addEventListener('click', ()=>{
      if(splitMode===0){
        isMainFull = !isMainFull;
        root.classList.toggle('main-full', isMainFull);
        root.classList.toggle('no-bars',  isMainFull);
      }else{
        fillState = (fillState+1)%4;
        root.classList.toggle('fit-0', fillState===0);
        root.classList.toggle('fit-1', fillState===1);
        root.classList.toggle('fit-2', fillState===2);
        root.classList.toggle('fit-3', fillState===3); // Overscan Ø¨Ù„Ø§ Ø­ÙˆØ§Ù Ø³ÙˆØ¯Ø§Ø¡
      }
    });

    // ØµÙˆØª
    btnSound.addEventListener('click', ()=>{
      if(!started) return;
      mainPlayer.muted = !mainPlayer.muted;
      if(!mainPlayer.muted) mainPlayer.play().catch(()=>{});
    });

    // ØªØ­ÙƒÙ… Ø²Ù…Ù†ÙŠ
    gBack.addEventListener('click', ()=>{
      if(!started) return;
      const t=(mainPlayer.currentTime||0)-5;
      mainPlayer.currentTime = clampToSeekable(mainPlayer,t);
      activePlayer.currentTime = clampToSeekable(activePlayer,t);
    });
    gFwd.addEventListener('click', ()=>{
      if(!started) return;
      const t=(mainPlayer.currentTime||0)+5;
      mainPlayer.currentTime = clampToSeekable(mainPlayer,t);
      activePlayer.currentTime = clampToSeekable(activePlayer,t);
    });
    gPlay.addEventListener('click', async ()=>{
      if(!started) return;
      if(mainPlayer.paused){ try{ await mainPlayer.play(); }catch(e){} }
      else { mainPlayer.pause(); }
    });

    scrub.addEventListener('input', ()=>{ if(started) isScrubbing=true; });
    scrub.addEventListener('change', ()=>{
      if(!started) return;
      const nt=parseFloat(scrub.value)||0;
      mainPlayer.currentTime = clampToSeekable(mainPlayer, nt);
      activePlayer.currentTime = clampToSeekable(activePlayer, nt);
      isScrubbing=false;
    });

    // ØªÙƒØ¨ÙŠØ± Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙÙ‚Ø·
    mainContainer.addEventListener('click', ()=>{
      if(splitMode!==0) return;
      isMainFull=!isMainFull;
      root.classList.toggle('main-full', isMainFull);
      root.classList.toggle('no-bars',  isMainFull);
    });

    // Ø§Ø®ØªØµØ§Ø±Ø§Øª
    document.addEventListener('keydown',(e)=>{
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startPlayback(); }
      if(e.key==='S'||e.key==='s'){ btnSplit.click(); }
      if(e.key==='F'||e.key==='f'){ mainContainer.click(); }
      if(e.key==='M'||e.key==='m'){ btnSound.click(); }
      if(e.key==='ArrowLeft'){ gBack.click(); }
      if(e.key==='ArrowRight'){ gFwd.click(); }
    });
  </script>

  <script>
    // HLS debug Ù„Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    (function addHlsDebug(){
      function wireDebug(video){
        const h = video && video.__hls;
        if(!h) return;
        h.on(Hls.Events.MANIFEST_PARSED, (_, data)=>{
          console.log('[HLS] MANIFEST_PARSED levels=', (data && data.levels||[]).map(l=>({h:l.height, codecs:l.codecs})));
        });
        h.on(Hls.Events.LEVEL_LOADED, (_, data)=>{
          console.log('[HLS] LEVEL_LOADED targetduration=', data?.details?.targetduration, 'frags=', data?.details?.fragments?.length);
        });
        h.on(Hls.Events.ERROR, (_, err)=>{
          console.error('[HLS] ERROR', err?.type, err?.details, err);
        });
      }
      const mo = new MutationObserver(()=>{
        document.querySelectorAll('video').forEach(v=>{
          if(!v.__debugWired && v.__hls){
            v.__debugWired = true;
            wireDebug(v);
          }
        });
      });
      mo.observe(document.body, {childList:true, subtree:true});
    })();
  </script>
</body>
</html>
