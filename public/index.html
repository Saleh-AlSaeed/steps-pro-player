<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps Production Co Player</title>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    body{margin:0;background:#000;font-family:sans-serif;overflow:hidden}
    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;inset:0;background:#000}
    video{width:100%;height:100%;object-fit:contain}
    #mainPreview{position:absolute;top:20px;right:20px;width:25%;height:25%;border:2px solid #fff3;z-index:10;border-radius:12px;cursor:pointer}
    #mainPreview:hover{box-shadow:0 0 12px #000a}
    .split #mainPreview{top:0;right:0;width:50%;height:100%;border-radius:0;border:0}
    .split #activeCam{left:0;width:50%;height:100%}
    .main-full #mainPreview{inset:0;width:100%;height:100%;z-index:11;border:0;border-radius:0}
    .main-full #activeCam{display:none}
    #controls{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:20}
    button{background:#e53935;color:#fff;border:0;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    button:hover{background:#d32f2f}
  </style>
</head>
<body>
  <div id="playerContainer">
    <div id="activeCam" class="videoFrame"></div>
    <div id="mainPreview" class="videoFrame"></div>
    <div id="controls">
      <button id="btnSplit">تقسيم</button>
      <button id="btnSound">🔊/🔇</button>
    </div>
  </div>

<script>
  window.sources = {
    main: "/hls/live/playlist.m3u8",
    cam1: "/hls/lastone/playlist.m3u8",
    cam2: "/hls/live2/playlist.m3u8"
  };

  const HLS_CFG = {
    lowLatencyMode: true,
    liveSyncDuration: 3,          // أقرب نقطة ممكنة للبث
    liveMaxLatencyDuration: 10,   // الحد الأعلى لتأخير البث
    backBufferLength: 30,
    maxLiveSyncPlaybackRate: 1.1,
    maxBufferLength: 12,
    maxMaxBufferLength: 20,
    maxBufferSize: 30*1000*1000,
    maxBufferHole: 0.5,
    nudgeOffset: 0.1,
    nudgeMaxRetry: 8,
    fragLoadingTimeOut: 8000,
    levelLoadingTimeOut: 8000,
    enableWorker: true,
    abrMaxWithRealBitrate: true,
    capLevelToPlayerSize: true,
    xhrSetup: xhr => { xhr.withCredentials=false; }
  };

  function attachHls(video, url){
    if(window.Hls && Hls.isSupported()){
      const hls = new Hls(HLS_CFG);
      video.__hls = hls;
      hls.attachMedia(video);
      hls.on(Hls.Events.MEDIA_ATTACHED,()=>hls.loadSource(url));

      hls.on(Hls.Events.ERROR,(ev,data)=>{
        console.warn("HLS error",data);
        if(data.fatal){
          switch(data.type){
            case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
            case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
            default: hls.destroy(); attachHls(video,url); break;
          }
        } else if(data.details === "bufferStalledError"){
          // نزّل الجودة لتفادي التقطيع
          const minLevel = hls.levels.findIndex(l=>l.height===Math.min(...hls.levels.map(x=>x.height)));
          if(minLevel>=0) hls.currentLevel=minLevel;
        }
      });
    }else if(video.canPlayType('application/vnd.apple.mpegURL')){
      video.src=url;
    }else video.src=url;
  }

  function createVideo(container,url,muted=true){
    const wrap=document.createElement("div"); wrap.style.cssText="position:absolute;inset:0";
    const v=document.createElement("video");
    v.playsInline=true; v.autoplay=true; v.muted=muted; v.controls=false; v.preload="auto";
    wrap.appendChild(v); container.appendChild(wrap);
    attachHls(v,url);
    return v;
  }

  const root=document.getElementById("playerContainer");
  const mainContainer=document.getElementById("mainPreview");
  const camContainer=document.getElementById("activeCam");
  const btnSplit=document.getElementById("btnSplit");
  const btnSound=document.getElementById("btnSound");

  let mainPlayer=createVideo(mainContainer,sources.main,true);
  let activePlayer=createVideo(camContainer,sources.cam2,true);

  btnSplit.onclick=()=>root.classList.toggle("split");
  btnSound.onclick=()=>{
    mainPlayer.muted=!mainPlayer.muted;
    if(!mainPlayer.muted) mainPlayer.play().catch(()=>{});
  };
  mainContainer.onclick=()=>root.classList.toggle("main-full");
</script>
</body>
</html>
