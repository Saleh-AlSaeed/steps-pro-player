<!-- اختصرت رأس الملف للتركيز على الكود -->
<script>
  // ========= الإعدادات =========
  let TD = 8; // targetduration (يتم تحديثه لاحقاً من المانيفست)
  const safeEdge = ()=> 40; // نبدأ دائماً ~40 ثانية وراء live edge

  // ضبط HLS
  const BASE_CFG = {
    lowLatencyMode: false,
    liveSyncDurationCount: 5,
    liveMaxLatencyDurationCount: 12,
    backBufferLength: 120,
    maxBufferLength: 50,   // ≥ 50s
    maxMaxBufferLength: 180,
    maxBufferHole: 2,
    nudgeOffset: 0.4,
    nudgeMaxRetry: 8,
    enableWorker: true,
    capLevelToPlayerSize: true,
    abrMaxWithRealBitrate: true,
    fragLoadingTimeOut: 15000,
    levelLoadingTimeOut: 15000,
    xhrSetup:(xhr)=>{ xhr.withCredentials=false; }
  };

  function attachHls(video,url){
    const hls=new Hls({...BASE_CFG});
    video.__hls=hls;
    hls.attachMedia(video);
    hls.on(Hls.Events.MEDIA_ATTACHED,()=>hls.loadSource(url));

    hls.on(Hls.Events.LEVEL_LOADED,(_,data)=>{
      if(data?.details?.targetduration){
        TD=data.details.targetduration;
        console.log("[HLS] targetduration=",TD);
      }
    });

    hls.on(Hls.Events.ERROR,(_,err)=>{
      if(err?.details==="bufferStalledError"){
        console.warn("[Guard] stall, jumping forward");
        video.currentTime += Math.max(2,TD*0.5); // قفزة ~4s
      }
      if(err.fatal){
        if(err.type===Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
        else if(err.type===Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
        else {hls.destroy(); attachHls(video,url);}
      }
    });
  }

  // ========= إنشاء الفيديو =========
  async function createVideo(container,url,muted=true){
    const wrap=document.createElement("div");wrap.style.cssText="position:absolute;inset:0";
    const v=document.createElement("video");
    v.playsInline=true;v.autoplay=true;v.muted=muted;v.controls=false;v.preload="auto";
    wrap.appendChild(v);container.appendChild(wrap);
    attachHls(v,url);

    // انتظر حتى يتجمع بافر كافٍ (≥10s) قبل البدء
    v.addEventListener("canplay",async()=>{
      let ready=false;
      while(!ready){
        const b=v.buffered;if(b&&b.length){
          const end=b.end(b.length-1),cur=v.currentTime;
          if(end-cur>=10){ready=true;break;}
        }
        await new Promise(r=>setTimeout(r,300));
      }
      try{await v.play();}catch{}
    });

    return v;
  }

  // ========= استخدام =========
  const mainContainer=document.getElementById("mainPreview");
  const camContainer =document.getElementById("activeCam");
  let mainPlayer,activePlayer;

  async function startPlayers(){
    mainPlayer=await createVideo(mainContainer,sources.main,true);
    activePlayer=await createVideo(camContainer,sources.cam2,true);

    // ابدأ متأخر 40s عن live edge
    mainPlayer.addEventListener("loadedmetadata",()=>{
      const r=mainPlayer.seekable;if(r&&r.length){
        const end=r.end(r.length-1);
        mainPlayer.currentTime=end-safeEdge();
        activePlayer.currentTime=end-safeEdge();
      }
    });
  }

  document.getElementById("startBtn").onclick=startPlayers;
</script>
